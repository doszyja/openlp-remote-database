# Progress Update - 2025-01-23

## Summary

This update covers improvements to authentication system, UI/UX fixes, and documentation updates.

---

## Authentication & Authorization Improvements

### Guild Member Login with Role-Based Permissions

**Problem**: Previously, only users with the required Discord role could log in. Users who were members of the Discord server but didn't have the role were completely blocked from accessing the application.

**Solution**: Implemented a two-tier authentication system:
- **All Discord guild members** can now log in and see their avatar/menu
- **Only users with the required role** can perform edit/delete/export actions

**Implementation Details**:

1. **Backend Changes**:
   - Added `hasEditPermission` field to `UserResponseDto`
   - Updated `validateDiscordUser()` in `AuthService` to allow login for all guild members, but set `hasEditPermission` based on role presence
   - Created `EditPermissionGuard` to protect edit/delete/export endpoints
   - Updated `SongController` to use `EditPermissionGuard` for POST, PATCH, DELETE, and ZIP export endpoints
   - Updated JWT payload to include `hasEditPermission` flag

2. **Frontend Changes**:
   - Added `hasEditPermission` to `AuthContext` interface and state
   - Updated `SongListPage`, `SongDetailPage`, and `HomePage` to use `hasEditPermission` instead of `isAuthenticated` for edit/delete actions
   - Updated `ProtectedRoute` to check `hasEditPermission` instead of `isAuthenticated`
   - All logged-in users (with or without permission) can see their avatar and menu

**Files Modified**:
- `apps/api/src/auth/dto/user-response.dto.ts`
- `apps/api/src/auth/auth.service.ts`
- `apps/api/src/auth/strategies/discord.strategy.ts`
- `apps/api/src/auth/strategies/jwt.strategy.ts`
- `apps/api/src/auth/guards/edit-permission.guard.ts` (new)
- `apps/api/src/songs/song.controller.ts`
- `apps/web/src/contexts/AuthContext.tsx`
- `apps/web/src/pages/SongListPage.tsx`
- `apps/web/src/pages/SongDetailPage.tsx`
- `apps/web/src/pages/HomePage.tsx`
- `apps/web/src/components/ProtectedRoute.tsx`

---

## UI/UX Fixes

### 1. SongListPage - Fixed Premature "No Songs" Message

**Problem**: During initial loading, the message "Nie znaleziono pieśni. Utwórz pierwszą pieśń!" appeared before the API response was received.

**Solution**: Added additional check to only show the message when:
- `allSongs.length === 0`
- `!isLoading`
- `!error`
- `page === 1`
- `data && data.data.length === 0` (ensures API response has been received)

**File Modified**: `apps/web/src/pages/SongListPage.tsx`

### 2. SongDetailPage - Fixed Blinking During Song Navigation

**Problem**: When changing songs, the loading spinner appeared immediately, causing visual blinking even for fast API responses.

**Solution**: Implemented debounced loading state:
- Added `showLoading` state with 200ms debounce delay
- Loading spinner only appears if loading takes longer than 200ms
- Prevents visual blinking for fast API responses
- Maintains smooth navigation experience

**File Modified**: `apps/web/src/pages/SongDetailPage.tsx`

---

## Documentation Updates

### Updated Files

1. **PROJECT_RULES.md**:
   - Added section on authentication and authorization rules
   - Documented `hasEditPermission` flag usage
   - Added guidelines for role-based access control

2. **PROGRESS.md**:
   - Added entry for 2025-01-23 progress
   - Documented authentication improvements
   - Documented UI/UX fixes

---

## Technical Details

### Authentication Flow

1. User clicks login → Redirected to Discord OAuth
2. Discord callback → Backend validates user:
   - Checks if user is in Discord guild (server)
   - If in guild: Allow login, set `hasEditPermission` based on role
   - If not in guild: Reject login
3. JWT token includes `hasEditPermission` flag
4. Frontend checks `hasEditPermission` for edit/delete actions
5. Backend `EditPermissionGuard` validates permission on protected endpoints

### Error Handling

- Users without required role can log in but see appropriate error messages when attempting restricted actions
- Backend returns `403 Forbidden` with descriptive message for unauthorized actions
- Frontend shows user-friendly messages in Polish

---

## Testing Recommendations

1. **Test guild member login without role**:
   - Should be able to log in
   - Should see avatar and menu
   - Should NOT see edit/delete buttons
   - Should see error when attempting to access protected routes

2. **Test guild member login with role**:
   - Should be able to log in
   - Should see avatar and menu
   - Should see edit/delete buttons
   - Should be able to perform all actions

3. **Test non-guild member**:
   - Should NOT be able to log in
   - Should see appropriate error message

4. **Test UI fixes**:
   - SongListPage: Verify "No songs" message doesn't appear during initial load
   - SongDetailPage: Verify no blinking when navigating between songs quickly

---

## Next Steps

1. Consider adding visual indicator for users without edit permission (e.g., badge or tooltip)
2. Consider adding admin panel for role management
3. Monitor authentication flow for edge cases
4. Consider adding audit logs for permission checks

---

**Date**: 2025-01-23
**Author**: Development Team

